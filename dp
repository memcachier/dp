#!/usr/bin/env bash

set -e

function runssh() {
  ssh -p $PORT $SSH_ARGS $REMOTE_USER@$REMOTE_HOST "$1"
}

# Default settings
PORT=22
BASE_DIR="\$HOME/app"
REMOTE_USER=${REMOTE_USER:-$(whoami)}
defaultenv="default"
envdir=${ENV:-$defaultenv}

if [[ -e ".dp/$envdir/config" ]]
then
  . ".dp/$envdir/config"
else
  echo "No .dp/$envdir/ directory found"
  exit 1
fi

if [[ $# -eq 0 ]]
then
  command="push"
else
  command=$1
  shift
fi

envs="cd $BASE_DIR/.envdir && for e in \`ls\`; do echo -n \"\$e=\"; cat \$e; done"

case "$command" in
  version) runssh "cat $BASE_DIR/versions/current/.gitversion"
    ;;
  init-server)
    cmd=$(cat <<EOF
mkdir -p $BASE_DIR/versions
mkdir -p $BASE_DIR/.envdir
touch $BASE_DIR/log
cat <<EF > $BASE_DIR/run
#!/usr/bin/env bash
cd \\\`dirname \\\$0\\\`/versions/current
IFS="[: ]"
read name cmd < Procfile
echo "Starting \\\$name..."
exec envdir ../../.envdir \\\$cmd
EF
chmod +x $BASE_DIR/run
EOF
)
    runssh "$cmd"
    ;;
  config) runssh "$envs"
    ;;
  config:get)
    runssh "cat $BASE_DIR/.envdir/$1"
    ;;
  config:set)
    IFS="="
    read key value <<< $1
    cmd="mkdir -p $BASE_DIR/.envdir && echo \"$value\" > $BASE_DIR/.envdir/$key"
    runssh "$cmd"
    ;;
  config:setbulk)
    cmd="mkdir -p $BASE_DIR/.envdir"
    IFS="="
    while read key value
    do
      cmd="$cmd; echo \"$value\" > $BASE_DIR/.envdir/$key"
    done
    runssh "$cmd"
    ;;
  config:unset) runssh "rm -f $BASE_DIR/.envdir/$1"
    ;;
  run) echo "$*" | runssh "cd $BASE_DIR/versions/current && envdir ../../.envdir bash"
    ;;
  logs)
    args="-n 100 $*"
    runssh "tail $args $BASE_DIR/log"
    ;;
  status) runssh "cd $BASE_DIR && svstat ."
    ;;
  stop)
    echo "Stopping app..."
    runssh "svc -d $BASE_DIR"
    ;;
  start)
    echo "Starting app..."
    cmd=$(cat <<EOF
svok $BASE_DIR
if [[ \$? -gt 0 ]]
then
  start-stop-daemon --no-close --background -m --pidfile $BASE_DIR/pid --start --startas \`which supervise\` -- $BASE_DIR &>> $BASE_DIR/log
else
  svc -u $BASE_DIR
fi
EOF
)
    runssh "$cmd"
    ;;
  restart)
    echo "Restarting app..."
    runssh "svc -d $BASE_DIR && svc -u $BASE_DIR"
    ;;
  deploy)

    [[ $# -gt 0 ]] && branch=$1 || branch=master
    githash=`git show-ref -s refs/heads/$branch`
    cmds=$(cat <<EOF 
set -e
cat > /tmp/app.tar;
export DIST_DIR=$BASE_DIR/versions/\`date -u +%Y%m%d%H%M\`
mkdir -p \$DIST_DIR
echo "Extracting app"
tar xvf /tmp/app.tar -C \$DIST_DIR
cd \$DIST_DIR
echo $githash > .gitversion
echo "Compiling..."

`cat .dp/compile`

rm -f \$DIST_DIR/../current
ln -s \$DIST_DIR \$DIST_DIR/../current
EOF
)
    git archive $branch . | runssh "$cmds"
    ;;
esac

